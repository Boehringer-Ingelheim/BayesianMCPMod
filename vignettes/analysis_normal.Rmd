---
title: "Analysis Example of Bayesian MCPMod for Continuous Data"
output: rmarkdown::html_vignette
number_sections: true
vignette: >
  %\VignetteIndexEntry{Analysis Example of Bayesian MCPMod for Continuous Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(BayesianMCPMod)
library(clinDR)
library(dplyr)

set.seed(7015)
```
This vignette shows how to apply the BayesianMCPMod package.

# Calculation of a MAP prior
In a first step a meta analytic prior will be calculated using historical data.
```{r Calculation of a MAP prior}
data("metaData")
testdata    <- as.data.frame(metaData)
dataset     <- filter(testdata, bname == "VIAGRA")
histcontrol <- filter(dataset, dose == 0, primtime == 12, indication == "ERECTILE DYSFUNCTION")

##Create MAP Prior
hist_data <- data.frame(
  trial = seq_len(4),
  est   = histcontrol$rslt,
  se    = histcontrol$se,
  sd    = histcontrol$sd,
  n     = histcontrol$sampsize)

dose_levels <- c(0, 50, 100, 200)

prior_list <- getPriorList(
  hist_data   = hist_data,
  dose_levels = dose_levels)

```
# Pre-Specification of candidate models 
```{r Pre-Specification of candidate models}
#Pre-Specification (B)MCPMod 

## candidate models for MCPMod
# linear function - no guestimates needed
exp <- DoseFinding::guesst(
  d     = 50,
  p     = c(0.2),
  model = "exponential",
  Maxd  = max(dose_levels))
emax <- DoseFinding::guesst(
  d     = 100,
  p     = c(0.9),
  model = "emax")

mods <- DoseFinding::Mods(
  linear      = NULL,
  emax        = emax,
  exponential = exp,
  doses       = dose_levels,
  maxEff      = 10,
  placEff     = 1.4)
```
# Assessing the Trial Design
```{r Assessing the Trial Design}
n_patients <- c(50, 50, 50, 50)

assessDesign(
  n_patients  = n_patients,
  mods        = mods,
  prior_list  = prior_list,
  n_sim       = 1e2)
```
# Trial results
```{r Trial results}
#Simulation of new trial 
##Note: This part will be simplified and direct results from one trial will be used
data_emax <- simulateData(
  n_patients  = n_patients,
  dose_levels = dose_levels,
  sd          = attr(prior_list, "sd_tot"),
  mods        = mods,
  true_model  = "emax")

posterior_emax <- getPosterior(
  data       = data_emax,
  prior_list = prior_list)
```

# Execution of Bayesian MCPMod Test step
```{r Execution of Bayesian MCPMod Test step}
crit_pval <- getCritProb(
  mods           = mods,
  dose_levels    = dose_levels,
  dose_weights   = n_patients,
  alpha_crit_val = 0.05)

contr_mat_prior <- getContrMat(
  mods           = mods,
  dose_levels    = dose_levels,
  dose_weights   = n_patients,
  prior_list     = prior_list)

BMCP_result <- performBayesianMCP(
  posteriors_list = posterior_emax,
  contr_mat       = contr_mat_prior, 
  crit_prob       = crit_pval)

BMCP_result
```

# Model fitting and Plotting
In the model fitting step the posterior distribution is used as basis. 
```{r Model fitting}
#Model fit
post_observed <- posterior_emax
model_shapes  <- c("linear", "emax", "exponential")

# Option a) Simplified approach by using frequentist idea
fit_simple <- getModelFits(
  models      = model_shapes,
  dose_levels = dose_levels,
  posterior   = post_observed,
  simple      = TRUE)

# Option b) Making use of the complete posterior distribution
fit <- getModelFits(
  models      = model_shapes,
  dose_levels = dose_levels,
  posterior   = post_observed,
  simple      = FALSE)
```

```{r Plotting}
plot(fit)
plot(fit_simple, cr_bands = TRUE)
```
For the plotting the credible intervals are shown as well.
