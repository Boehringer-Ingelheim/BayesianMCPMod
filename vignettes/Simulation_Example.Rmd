---
title: "Simulation Example of Bayesian MCPMod for Continuous Data"
output: rmarkdown::html_vignette
number_sections: true
vignette: >
  %\VignetteIndexEntry{Simulation Example of Bayesian MCPMod for Continuous Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(BayesianMCPMod)
library(clinDR)
library(dplyr)

set.seed(7015)
```

# Background and data

In this vignette we will show the use of the Bayesian MCPMod package for trial planning for continuous distributed data. 
As in [the analysis example vignette](analysis_normal.html) we focus on the indication MDD and make use of historical data that is included in the clinDR package. 
More specifically trial results for BRINTELLIX will be utilized to establish an informative prior for the control group.

# Calculation of a MAP prior
In a first step a meta analytic prior will be calculated using historical data from 5 trials (with main endpoint Change from baseline in MADRS score after 8 weeks).
Please note that only information from the control group will be integrated (leading to an informative mixture prior for the control group), while for the active groups a non-informative prior will be specified.


```{r Historical Data}
data("metaData")
testdata    <- as.data.frame(metaData)
dataset     <- filter(testdata, bname == "BRINTELLIX")
histcontrol <- filter(dataset, dose == 0, primtime == 8, indication == "MAJOR DEPRESSIVE DISORDER")

##Create MAP Prior
hist_data <- data.frame(
  trial = histcontrol$nctno,
  est   = histcontrol$rslt,
  se    = histcontrol$se,
  sd    = histcontrol$sd,
  n     = histcontrol$sampsize)

sd_tot <- with(hist_data, sum(sd * n) / sum(n))
```

We will make use of the same getPriorList function as in the [analysis example vignette](analysis_normal.html) to create a MAP prior.

```{r Calculation of a MAP prior, echo = FALSE}
getPriorList <- function (
  
  hist_data,
  dose_levels,
  dose_names    = NULL,
  robust_weight = 0.5
  
) {
  
  sd_tot <- with(hist_data, sum(sd * n) / sum(n))
  
  gmap <- RBesT::gMAP(
    formula    = cbind(est, se) ~ 1 | trial,
    weights    = hist_data$n,
    data       = hist_data,
    family     = gaussian,
    beta.prior = cbind(0, 100 * sd_tot),
    tau.dist   = "HalfNormal",
    tau.prior  = cbind(0, sd_tot / 4))
  
  prior_ctr <- RBesT::automixfit(gmap)
  
  if (!is.null(robust_weight)) {
    
    prior_ctr <- suppressMessages(RBesT::robustify(
      priormix = prior_ctr,
      weight   = robust_weight,
      sigma    = sd_tot))
    
  }
  
  prior_trt <- RBesT::mixnorm(
    comp1 = c(w = 1, m = summary(prior_ctr)[1], n = 1),
    sigma = sd_tot,
    param = "mn")
  
  prior_list <- c(list(prior_ctr),
                  rep(x     = list(prior_trt),
                      times = length(dose_levels[-1])))
  
  if (is.null(dose_names)) {
    
    dose_names <- c("Ctr", paste0("DG_", seq_along(dose_levels[-1])))
    
  }
  
  names(prior_list) <- dose_names
  attr(prior_list, "dose_levels") <- dose_levels
  attr(prior_list, "sd_tot")      <- sd_tot
  
  return (prior_list)
  
}
```


```{r Evaluation of a MAP prior}
dose_levels <- c(0, 2.5, 5, 10, 20)

prior_list <- getPriorList(
  hist_data   = hist_data,
  dose_levels = dose_levels,
  robust_weight = 0.3)

getESS(prior_list)
```

# Specification of new trial design 

For the hypothetical new trial we plan with 4 active dose levels \eqn{2.5, 5, 10, 20} and we specify a broad set of potential dose-response relationships, including a linear, an exponential, an emax and a sigEMax model.  
Furthermore we assume a maximum effect of -3 on top of control (i.e. assuming that active treatment can reduce the MADRS score after 8 weeks by up to 15.8) and plan a trial with 80 patients for all active groups and 60 patients for control.
```{r}
#Pre-Specification (B)MCPMod 

## candidate models for MCPMod
# linear function - no guestimates needed
exp     <- DoseFinding::guesst(d     = 5,
                               p     = c(0.2),
                               model = "exponential",
                               Maxd  = max(dose_levels))
emax    <- DoseFinding::guesst(d     = 2.5,
                               p     = c(0.9),
                               model = "emax")
sigemax <- DoseFinding::guesst(d     = c(2.5, 5),
                               p     = c(0.1, 0.6),
                               model = "sigEmax")
sigemax2 <- DoseFinding::guesst(d     = c(2, 4),
                               p     = c(0.3, 0.8),
                               model = "sigEmax")


mods <- DoseFinding::Mods(
  linear      = NULL,
  emax        = emax,
  exponential = exp,
  sigEmax     = rbind(sigemax, sigemax2),
  #betaMod     = beta,
  doses       = dose_levels,
  maxEff      = -3,
  placEff     = -12.8)

n_patients = c(60, 80, 80, 80, 80)
```

# Calculation of success probabilities

To calculate success probabilities for the different assumed dose-response models and the specified trial design we will apply the assessDesign function.  

```{r}
success_probabilities <- assessDesign(
  n_patients  = n_patients,
  mods        = mods,
  prior_list  = prior_list,
  sd          = sd_tot)

success_probabilities
```

As alternative design we will evaluate a design with the same overall sample size but putting more patients on the highest dose group (and control).

```{r}
success_probabilities_uneq <- assessDesign(
  n_patients  = c(80, 60, 60, 60, 120),
  mods        = mods,
  prior_list  = prior_list,
  sd          = sd_tot)
success_probabilities_uneq
```

For this specific trial setting the adapted allocation ratio leads to increased success probabilities under all assumed dose response relationships.

Instead of specifying the assumed effects via the models it is also possible to directly specify the effects for the individual dose levels via the dr_means input. This allows e.g. also the simulation of scenarios with a prior-data conflict.

```{r}
success_probabilities <- assessDesign(
  n_patients  = c(60, 80, 80, 80, 80),
  mods        = mods,
  prior_list  = prior_list,
  sd          = sd_tot,
  dr_means = c(-12,-14,-15,-16,-17))
success_probabilities
```